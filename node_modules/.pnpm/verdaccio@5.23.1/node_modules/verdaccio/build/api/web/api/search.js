"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _express = require("express");
var _constants = require("../../../lib/constants");
var _search = _interopRequireDefault(require("../../../lib/search"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function addSearchWebApi(storage, auth) {
  const route = (0, _express.Router)(); /* eslint new-cap: 0 */
  // Search package
  route.get('/search/:anything', function (req, res, next) {
    const results = _search.default.query(req.params.anything);
    // FUTURE: figure out here the correct type
    const packages = [];
    const getPackageInfo = function (i) {
      storage.getPackage({
        name: results[i].ref,
        uplinksLook: false,
        callback: (err, entry) => {
          if (!err && entry) {
            auth.allow_access({
              packageName: entry.name
            }, req.remote_user, function (err, allowed) {
              if (err || !allowed) {
                return;
              }
              packages.push(entry.versions[entry[_constants.DIST_TAGS].latest]);
            });
          }
          if (i >= results.length - 1) {
            next(packages);
          } else {
            getPackageInfo(i + 1);
          }
        }
      });
    };
    if (results.length) {
      getPackageInfo(0);
    } else {
      next([]);
    }
  });
  return route;
}
var _default = addSearchWebApi;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZXhwcmVzcyIsInJlcXVpcmUiLCJfY29uc3RhbnRzIiwiX3NlYXJjaCIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJvYmoiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsImFkZFNlYXJjaFdlYkFwaSIsInN0b3JhZ2UiLCJhdXRoIiwicm91dGUiLCJSb3V0ZXIiLCJnZXQiLCJyZXEiLCJyZXMiLCJuZXh0IiwicmVzdWx0cyIsIlNlYXJjaCIsInF1ZXJ5IiwicGFyYW1zIiwiYW55dGhpbmciLCJwYWNrYWdlcyIsImdldFBhY2thZ2VJbmZvIiwiaSIsImdldFBhY2thZ2UiLCJuYW1lIiwicmVmIiwidXBsaW5rc0xvb2siLCJjYWxsYmFjayIsImVyciIsImVudHJ5IiwiYWxsb3dfYWNjZXNzIiwicGFja2FnZU5hbWUiLCJyZW1vdGVfdXNlciIsImFsbG93ZWQiLCJwdXNoIiwidmVyc2lvbnMiLCJESVNUX1RBR1MiLCJsYXRlc3QiLCJsZW5ndGgiLCJfZGVmYXVsdCIsImV4cG9ydHMiXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYXBpL3dlYi9hcGkvc2VhcmNoLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuXG5pbXBvcnQgeyBQYWNrYWdlIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5cbmltcG9ydCBBdXRoIGZyb20gJy4uLy4uLy4uL2xpYi9hdXRoJztcbmltcG9ydCB7IERJU1RfVEFHUyB9IGZyb20gJy4uLy4uLy4uL2xpYi9jb25zdGFudHMnO1xuaW1wb3J0IFNlYXJjaCBmcm9tICcuLi8uLi8uLi9saWIvc2VhcmNoJztcbmltcG9ydCBTdG9yYWdlIGZyb20gJy4uLy4uLy4uL2xpYi9zdG9yYWdlJztcbmltcG9ydCB7ICROZXh0RnVuY3Rpb25WZXIsICRSZXF1ZXN0RXh0ZW5kLCAkUmVzcG9uc2VFeHRlbmQgfSBmcm9tICcuLi8uLi8uLi90eXBlcyc7XG5cbmZ1bmN0aW9uIGFkZFNlYXJjaFdlYkFwaShzdG9yYWdlOiBTdG9yYWdlLCBhdXRoOiBBdXRoKTogUm91dGVyIHtcbiAgY29uc3Qgcm91dGUgPSBSb3V0ZXIoKTsgLyogZXNsaW50IG5ldy1jYXA6IDAgKi9cbiAgLy8gU2VhcmNoIHBhY2thZ2VcbiAgcm91dGUuZ2V0KFxuICAgICcvc2VhcmNoLzphbnl0aGluZycsXG4gICAgZnVuY3Rpb24gKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgICBjb25zdCByZXN1bHRzOiBhbnkgPSBTZWFyY2gucXVlcnkocmVxLnBhcmFtcy5hbnl0aGluZyk7XG4gICAgICAvLyBGVVRVUkU6IGZpZ3VyZSBvdXQgaGVyZSB0aGUgY29ycmVjdCB0eXBlXG4gICAgICBjb25zdCBwYWNrYWdlczogYW55W10gPSBbXTtcblxuICAgICAgY29uc3QgZ2V0UGFja2FnZUluZm8gPSBmdW5jdGlvbiAoaSk6IHZvaWQge1xuICAgICAgICBzdG9yYWdlLmdldFBhY2thZ2Uoe1xuICAgICAgICAgIG5hbWU6IHJlc3VsdHNbaV0ucmVmLFxuICAgICAgICAgIHVwbGlua3NMb29rOiBmYWxzZSxcbiAgICAgICAgICBjYWxsYmFjazogKGVyciwgZW50cnk6IFBhY2thZ2UpOiB2b2lkID0+IHtcbiAgICAgICAgICAgIGlmICghZXJyICYmIGVudHJ5KSB7XG4gICAgICAgICAgICAgIGF1dGguYWxsb3dfYWNjZXNzKFxuICAgICAgICAgICAgICAgIHsgcGFja2FnZU5hbWU6IGVudHJ5Lm5hbWUgfSxcbiAgICAgICAgICAgICAgICByZXEucmVtb3RlX3VzZXIsXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKGVyciwgYWxsb3dlZCk6IHZvaWQge1xuICAgICAgICAgICAgICAgICAgaWYgKGVyciB8fCAhYWxsb3dlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgIHBhY2thZ2VzLnB1c2goZW50cnkudmVyc2lvbnNbZW50cnlbRElTVF9UQUdTXS5sYXRlc3RdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpID49IHJlc3VsdHMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICBuZXh0KHBhY2thZ2VzKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGdldFBhY2thZ2VJbmZvKGkgKyAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgIH07XG5cbiAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCkge1xuICAgICAgICBnZXRQYWNrYWdlSW5mbygwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5leHQoW10pO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxuICByZXR1cm4gcm91dGU7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFkZFNlYXJjaFdlYkFwaTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBQUEsUUFBQSxHQUFBQyxPQUFBO0FBS0EsSUFBQUMsVUFBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsT0FBQSxHQUFBQyxzQkFBQSxDQUFBSCxPQUFBO0FBQXlDLFNBQUFHLHVCQUFBQyxHQUFBLFdBQUFBLEdBQUEsSUFBQUEsR0FBQSxDQUFBQyxVQUFBLEdBQUFELEdBQUEsS0FBQUUsT0FBQSxFQUFBRixHQUFBO0FBSXpDLFNBQVNHLGVBQWVBLENBQUNDLE9BQWdCLEVBQUVDLElBQVUsRUFBVTtFQUM3RCxNQUFNQyxLQUFLLEdBQUcsSUFBQUMsZUFBTSxHQUFFLENBQUMsQ0FBQztFQUN4QjtFQUNBRCxLQUFLLENBQUNFLEdBQUcsQ0FDUCxtQkFBbUIsRUFDbkIsVUFBVUMsR0FBbUIsRUFBRUMsR0FBb0IsRUFBRUMsSUFBc0IsRUFBUTtJQUNqRixNQUFNQyxPQUFZLEdBQUdDLGVBQU0sQ0FBQ0MsS0FBSyxDQUFDTCxHQUFHLENBQUNNLE1BQU0sQ0FBQ0MsUUFBUSxDQUFDO0lBQ3REO0lBQ0EsTUFBTUMsUUFBZSxHQUFHLEVBQUU7SUFFMUIsTUFBTUMsY0FBYyxHQUFHLFNBQUFBLENBQVVDLENBQUMsRUFBUTtNQUN4Q2YsT0FBTyxDQUFDZ0IsVUFBVSxDQUFDO1FBQ2pCQyxJQUFJLEVBQUVULE9BQU8sQ0FBQ08sQ0FBQyxDQUFDLENBQUNHLEdBQUc7UUFDcEJDLFdBQVcsRUFBRSxLQUFLO1FBQ2xCQyxRQUFRLEVBQUVBLENBQUNDLEdBQUcsRUFBRUMsS0FBYyxLQUFXO1VBQ3ZDLElBQUksQ0FBQ0QsR0FBRyxJQUFJQyxLQUFLLEVBQUU7WUFDakJyQixJQUFJLENBQUNzQixZQUFZLENBQ2Y7Y0FBRUMsV0FBVyxFQUFFRixLQUFLLENBQUNMO1lBQUssQ0FBQyxFQUMzQlosR0FBRyxDQUFDb0IsV0FBVyxFQUNmLFVBQVVKLEdBQUcsRUFBRUssT0FBTyxFQUFRO2NBQzVCLElBQUlMLEdBQUcsSUFBSSxDQUFDSyxPQUFPLEVBQUU7Z0JBQ25CO2NBQ0Y7Y0FFQWIsUUFBUSxDQUFDYyxJQUFJLENBQUNMLEtBQUssQ0FBQ00sUUFBUSxDQUFDTixLQUFLLENBQUNPLG9CQUFTLENBQUMsQ0FBQ0MsTUFBTSxDQUFDLENBQUM7WUFDeEQsQ0FBQyxDQUNGO1VBQ0g7VUFFQSxJQUFJZixDQUFDLElBQUlQLE9BQU8sQ0FBQ3VCLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDM0J4QixJQUFJLENBQUNNLFFBQVEsQ0FBQztVQUNoQixDQUFDLE1BQU07WUFDTEMsY0FBYyxDQUFDQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1VBQ3ZCO1FBQ0Y7TUFDRixDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsSUFBSVAsT0FBTyxDQUFDdUIsTUFBTSxFQUFFO01BQ2xCakIsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUNuQixDQUFDLE1BQU07TUFDTFAsSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUNWO0VBQ0YsQ0FBQyxDQUNGO0VBRUQsT0FBT0wsS0FBSztBQUNkO0FBQUMsSUFBQThCLFFBQUEsR0FFY2pDLGVBQWU7QUFBQWtDLE9BQUEsQ0FBQW5DLE9BQUEsR0FBQWtDLFFBQUEifQ==