"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handleSlash = void 0;
const deps_js_1 = require("../../deps.js");
const Context_js_1 = require("../classes/Context.js");
const errors_js_1 = require("../interfaces/errors.js");
const createOptionResults_js_1 = require("../utils/createOptionResults.js");
/**
 * It handles the slash command
 * @param {AmethystBot} bot - AmethystBot - The bot instance
 * @param {Interaction} data - Interaction
 * @returns The data object
 */
async function handleSlash(bot, data) {
    if (data.type !== 2 || !data.data?.name) {
        return;
    }
    let command;
    for (let i = 0; i < bot.category.size; i++) {
        command = bot.category
            .at(i)
            ?.getCommandFromInteraction(data.data.name, data.data.options[0].name);
        if (command)
            break;
    }
    if (!command)
        return;
    if (command.private) {
        bot.helpers.sendInteractionResponse(data.id, data.token, {
            type: deps_js_1.InteractionResponseTypes.DeferredUpdateMessage,
            data: { flags: 1 << 6 },
        });
    }
    else {
        bot.helpers.sendInteractionResponse(data.id, data.token, {
            type: deps_js_1.InteractionResponseTypes.DeferredChannelMessageWithSource,
        });
    }
    const context = await (0, Context_js_1.createContext)({
        interaction: { ...data, data: data.data.options?.[0] },
    }, (0, createOptionResults_js_1.createOptionResults)(bot, command.args || [], {
        interaction: data,
    }), command, bot);
    for (let i = 0; i < bot.inhibitors.size; i++) {
        const e = bot.inhibitors.at(i);
        const f = await e(bot, command, context);
        if (typeof f != "boolean") {
            return bot.events.commandError?.(bot, {
                data,
                error: f,
            }, context);
        }
    }
    try {
        bot.events.commandStart?.(bot, command, data);
        await command.execute(bot, context);
        bot.events.commandEnd?.(bot, command, data);
    }
    catch (e) {
        if (bot.events.commandError) {
            bot.events.commandError(bot, {
                error: { type: errors_js_1.ErrorEnums.COMMANDRUNTIME },
                data,
            }, context);
        }
        else
            throw e;
    }
}
exports.handleSlash = handleSlash;
